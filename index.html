<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>普普風 HTML 分享站 (Firebase版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 QR Code 生成函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Anton&display=swap" rel="stylesheet">
    <style>
        /* 自定義普普藝術風格 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6; /* 淺灰色背景 */
            background-image: radial-gradient(#4f46e5 10%, transparent 11%),
                              radial-gradient(#4f46e5 10%, transparent 11%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        .font-anton {
            font-family: 'Anton', sans-serif;
        }
        .pop-shadow {
            box-shadow: 8px 8px 0px rgba(0, 0, 0, 1);
        }
        .pop-shadow-sm {
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 1);
        }
        .pop-button {
            transition: all 0.15s ease-out;
        }
        .pop-button:hover {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .pop-button:active {
            transform: translate(6px, 6px);
            box-shadow: none;
        }
        .card {
            transition: all 0.2s ease-out;
            position: relative;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 12px 12px 0px rgba(0, 0, 0, 1);
        }
        /* QR Code 容器樣式 */
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 4px solid black;
            margin-bottom: 1.5rem;
        }
        #qrcode-container img {
            display: block;
            margin: auto;
        }
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid black;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .card:hover .delete-btn {
            opacity: 1;
        }
        /* Tab 樣式 */
        .tab-btn-active {
            background-color: #facc15; /* yellow-400 */
            border-width: 2px 2px 0 2px;
            border-color: black;
            border-radius: 0.5rem 0.5rem 0 0;
            transform: translateY(2px);
        }
        .tab-btn-inactive {
             background-color: #e5e7eb; /* gray-200 */
             color: #4b5563; /* gray-600 */
        }
        /* 滾動條樣式 */
        #helpModal::-webkit-scrollbar {
            width: 12px;
        }
        #helpModal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #helpModal::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 2px solid #f1f1f1;
        }
        #helpModal::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- 登入畫面 -->
    <div id="login-screen" class="fixed inset-0 bg-yellow-300 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-8 border-8 border-black rounded-lg pop-shadow text-center">
            <h2 class="font-anton text-3xl mb-4 text-black">歡迎使用！</h2>
            <p class="mb-6 text-gray-700">請建立一個新的使用者ID，或選擇一個已存在的ID來開始。</p>
            
            <div class="mb-4">
                <label for="loginUserIdInput" class="block mb-2 font-bold text-left">使用者ID (可自訂)</label>
                <input type="text" id="loginUserIdInput" placeholder="例如: project-A 或 Kents-Account" class="w-full p-3 border-2 border-black rounded-lg">
            </div>

            <div class="mb-6">
                <label for="existingUserSelect" class="block mb-2 font-bold text-left">或選擇已存在的ID</label>
                <select id="existingUserSelect" class="w-full p-3 border-2 border-black rounded-lg bg-white">
                    <option value="">-- 請選擇 --</option>
                    <!-- 已存在的ID將會動態生成於此 -->
                </select>
            </div>
            
            <button id="loginBtn" class="w-full pop-button pop-shadow-sm bg-blue-500 text-white font-bold py-3 px-8 border-2 border-black rounded-lg text-lg">進入分享站</button>
            <p id="loginStatus" class="text-red-600 h-4 mt-2 font-bold"></p>
        </div>
    </div>


    <!-- 主容器 (預設隱藏) -->
    <div id="main-app" class="hidden container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="relative bg-yellow-300 border-4 border-black p-6 mb-8 pop-shadow">
            <h1 class="font-anton text-4xl md:text-6xl text-center text-black tracking-wider">POP HTML SHARE</h1>
            <p class="text-center text-black mt-2">普普風 HTML 分享站 (Firebase版)</p>
            <button id="helpBtn" class="absolute top-2 right-2 text-4xl hover:scale-110 transition-transform">❓</button>
        </header>

        <!-- 使用者 ID 區塊 -->
        <div id="user-section" class="bg-blue-200 border-4 border-black p-4 mb-8 pop-shadow">
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <p class="font-bold shrink-0">目前使用者ID：<span id="currentUserIdDisplay" class="bg-white px-2 py-1 rounded"></span></p>
                <button id="switchUserBtn" class="w-full sm:w-auto pop-button pop-shadow-sm bg-green-500 text-white font-bold py-2 px-4 border-2 border-black rounded-lg">切換/管理ID</button>
            </div>
        </div>


        <!-- 上傳區塊 -->
        <div id="upload-section" class="bg-white border-4 border-black p-6 mb-8 pop-shadow">
            <h2 class="font-anton text-2xl text-black mb-4">1. 新增你的 HTML 圖卡</h2>

            <!-- Tab Navigation -->
            <div class="flex border-b-2 border-black">
                <button id="tab-file-btn" class="tab-btn-active py-2 px-6 font-bold">從檔案上傳</button>
                <button id="tab-code-btn" class="tab-btn-inactive py-2 px-6 font-bold">直接貼上程式碼</button>
            </div>

            <!-- Tab Content -->
            <div class="pt-6">
                <!-- 檔案上傳內容 -->
                <div id="tab-file-content">
                    <label for="htmlFile" class="block mb-1 font-bold text-sm">選擇檔案</label>
                    <input type="file" id="htmlFile" accept=".html" class="w-full text-black file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-2 file:border-black file:text-sm file:font-semibold file:bg-pink-400 file:text-black hover:file:bg-pink-500">
                </div>
                <!-- 程式碼貼上內容 -->
                <div id="tab-code-content" class="hidden">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="htmlFileName" class="block mb-1 font-bold text-sm">檔案名稱 (必填)</label>
                            <input type="text" id="htmlFileName" placeholder="例如: my-cool-game.html" class="w-full p-2 border-2 border-black rounded-lg">
                        </div>
                        <div>
                            <label for="htmlCode" class="block mb-1 font-bold text-sm">貼上 HTML 程式碼 (必填)</label>
                            <textarea id="htmlCode" rows="6" placeholder="<!DOCTYPE html>..." class="w-full p-2 border-2 border-black rounded-lg font-mono text-sm"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 共用設定 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start mt-4 border-t-2 border-black pt-6">
                 <div>
                    <label for="customId" class="block mb-1 font-bold text-sm">自訂ID (選填，僅限英文/數字)</label>
                    <input type="text" id="customId" placeholder="例如: my-awesome-page" class="w-full p-2 border-2 border-black rounded-lg">
                </div>
                <div>
                    <label for="htmlDescription" class="block mb-1 font-bold text-sm">程式說明 (選填)</label>
                    <input type="text" id="htmlDescription" placeholder="例如: 這是一個OOXX的小遊戲" class="w-full p-2 border-2 border-black rounded-lg">
                </div>
            </div>

            <button id="uploadBtn" class="mt-6 w-full pop-button pop-shadow-sm bg-blue-500 text-white font-bold py-3 px-8 border-2 border-black rounded-lg text-lg">上傳</button>
            <div id="status" class="mt-4 text-center font-bold"></div>
        </div>


        <div id="card-list-section">
            <h2 class="font-anton text-2xl text-black mb-4 bg-white border-4 border-black p-4 pop-shadow inline-block">2. 點擊圖卡分享或管理</h2>
            <div id="cardContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 mt-4">
                <!-- 圖卡將會動態生成於此 -->
            </div>
        </div>
    </div>

    <!-- 分享彈出視窗 -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-pink-300 w-full max-w-md p-8 border-8 border-black rounded-lg pop-shadow relative">
            <button id="closeShareModalBtn" class="absolute top-2 right-4 text-4xl font-bold hover:text-red-500">&times;</button>
            <h2 id="shareModalTitle" class="font-anton text-2xl mb-4 text-black text-center truncate">分享網頁</h2>
            <div id="qrcode-container"></div>
            <div class="relative mb-4">
                <input type="text" id="shareUrl" readonly class="w-full p-3 border-4 border-black rounded-lg bg-white text-sm">
                <button id="copyUrlBtn" class="absolute right-0 top-0 h-full px-4 bg-yellow-400 border-l-4 border-black text-black font-bold hover:bg-yellow-500">複製</button>
            </div>
            <a id="openLinkBtn" href="#" target="_blank" class="block w-full text-center pop-button pop-shadow-sm bg-green-500 text-white font-bold py-3 px-8 border-2 border-black rounded-lg text-lg">在新視窗開啟</a>
            <p id="copyStatus" class="text-center text-sm font-bold text-green-700 h-4 mt-2"></p>
        </div>
    </div>

    <!-- 刪除確認視窗 -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 border-8 border-red-500 rounded-lg pop-shadow relative">
            <h2 class="font-anton text-2xl mb-4 text-black text-center">確認刪除？</h2>
            <p id="deleteConfirmText" class="text-center mb-6">您確定要刪除這個檔案嗎？此操作無法復原。</p>
            <div class="flex justify-around gap-4">
                <button id="cancelDeleteBtn" class="w-full pop-button pop-shadow-sm bg-gray-300 font-bold py-2 px-6 border-2 border-black rounded-lg">取消</button>
                <button id="confirmDeleteBtn" class="w-full pop-button pop-shadow-sm bg-red-500 text-white font-bold py-2 px-6 border-2 border-black rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <!-- 說明彈出視窗 -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 border-8 border-yellow-300 rounded-lg pop-shadow relative">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-4xl font-bold hover:text-red-500">&times;</button>
            <h2 class="font-anton text-3xl mb-4 text-blue-600">Firebase 設定教學</h2>
            <p class="mb-4">本工具已改用 Firebase 作為後端，設定一次即可永久使用。請依照以下步驟設定：</p>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-xl mb-2">步驟一：建立 Firebase 專案</h3>
                    <p>1. 前往 <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase 控制台</a> 並登入您的 Google 帳號。</p>
                    <p>2. 點擊「新增專案」，輸入一個您喜歡的專案名稱 (例如 `my-html-share`)，然後按照畫面指示完成專案建立。</p>
                </div>
                <div>
                    <h3 class="font-bold text-xl mb-2">步驟二：在專案中建立「網頁應用程式」</h3>
                    <p>1. 進入您剛建立好的專案後，在主畫面上點擊網頁圖示 ( <strong>&lt;/&gt;</strong> ) 來新增一個網頁應用程式。</p>
                    <p>2. 輸入一個應用程式暱稱 (例如 `分享站`)，然後點擊「註冊應用程式」。</p>
                    <p>3. 註冊後，畫面會顯示一段程式碼，請找到並完整複製 `firebaseConfig` 的部分。它看起來像這樣：</p>
                    <div class="bg-gray-800 text-white p-4 rounded-lg my-2 text-sm">
<pre><code>
const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
};
</code></pre>
                    </div>
                     <p>4. 複製後，點擊「繼續前往主控台」。</p>
                </div>
                <div>
                    <h3 class="font-bold text-xl mb-2">步驟三：設定 Firestore 資料庫</h3>
                    <p>1. 在左側選單中，點擊「建構」 -> 「Firestore Database」。</p>
                    <p>2. 點擊「建立資料庫」，選擇在「測試模式」下啟動，然後點擊「下一步」。</p>
                    <p>3. 選擇離您最近的地區 (例如 `asia-east1` (台灣) 或 `asia-northeast1` (東京))，然後點擊「啟用」。</p>
                </div>
                 <div class="border-4 border-yellow-400 p-4 rounded-lg bg-yellow-50">
                    <h3 class="font-bold text-xl mb-2 text-red-600">步驟四：啟用匿名登入 (重要！)</h3>
                    <p>1. 在左側選單中，點擊「建構」 -> 「Authentication」。</p>
                    <p>2. 點擊「開始使用」。</p>
                    <p>3. 在「登入方式」分頁中，從供應商清單中找到並點擊「匿名」。</p>
                    <p>4. 將「啟用」的開關打開，然後點擊「儲存」。這個步驟是為了讓程式可以正常登入後端。</p>
                </div>
                 <div>
                    <h3 class="font-bold text-xl mb-2">步驟五：修改資料庫安全規則</h3>
                    <p>1. 在 Firestore Database 頁面，點擊上方的「規則」分頁。</p>
                    <p>2. 將編輯器中原有的規則全部刪除，並貼上以下新的規則：</p>
                    <div class="bg-gray-800 text-white p-4 rounded-lg my-2 text-sm">
<pre><code>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 任何人都可以讀取單一頁面
    match /pages/{pageId} {
      allow read: if true;
      // 只有頁面的建立者可以修改或刪除
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    // 只有經過驗證的使用者可以建立自己的頁面或讀取自己的頁面列表
    match /pages/{document=**} {
        allow create, list: if request.auth != null;
    }
  }
}
</code></pre>
                    </div>
                    <p>3. 點擊「發布」。這將確保您的資料庫安全，同時允許公開分享頁面。</p>
                </div>
                <div>
                    <h3 class="font-bold text-xl mb-2">步驟六：將 `firebaseConfig` 貼到 HTML 檔案中</h3>
                    <p>最後，將您在「步驟二」複製的 `firebaseConfig` 物件，完整貼到這個 HTML 檔案底部的 &lt;script&gt; 區塊中對應的位置，取代原有的範例程式碼。</p>
                    <pre class="bg-gray-200 p-2 rounded-lg text-sm"><code>// ▼▼▼▼▼ 請將您從 Firebase 複製的設定碼貼在這裡 ▼▼▼▼▼
const firebaseConfig = {
    // ... 貼在這裡 ...
};
// ▲▲▲▲▲ 請將您從 Firebase 複製的設定碼貼在這裡 ▲▲▲▲▲</code></pre>
                    <p class="font-bold text-red-600 mt-2">完成後儲存檔案，重新用瀏覽器開啟，您的 HTML 分享站就可以正常運作了！</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center p-4 mt-8 text-sm text-gray-600">
        Made by <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-600 font-bold">阿剛老師</a>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // 導入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, deleteDoc, doc, query, where, serverTimestamp, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
        // ▼▼▼▼▼ 請將您在步驟二從 Firebase 複製的設定碼貼在這裡 ▼▼▼▼▼
        // 注意：這是一個範例，您必須用您自己的設定碼取代它才能正常運作！
        const firebaseConfig = {
  apiKey: "AIzaSyB2EnCWkqKz4nd4fyMX0eGNlaM3P0nm3Vk",
  authDomain: "kent-html-share.firebaseapp.com",
  projectId: "kent-html-share",
  storageBucket: "kent-html-share.firebasestorage.app",
  messagingSenderId: "592634705039",
  appId: "1:592634705039:web:cb21218f14aa9ed2276cfa"
        };
        // ▲▲▲▲▲ 請將您在步驟二從 Firebase 複製的設定碼貼在這裡 ▲▲▲▲▲

        // --- DOM 元素 (提前宣告以供全域使用) ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const helpModal = document.getElementById('helpModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        // --- 應用程式主邏輯 ---
        // 檢查使用者是否已填入自己的 Firebase 設定
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            // 如果還是預設值，就顯示錯誤訊息，並停止執行後續程式碼
            loginScreen.classList.add('hidden'); // 隱藏登入畫面
            mainApp.classList.remove('hidden'); // 顯示主容器
            
            // 在主容器中顯示設定教學提示
            mainApp.innerHTML = `
                <header class="relative bg-yellow-300 border-4 border-black p-6 mb-8 pop-shadow">
                    <h1 class="font-anton text-4xl md:text-6xl text-center text-black tracking-wider">POP HTML SHARE</h1>
                    <p class="text-center text-black mt-2">普普風 HTML 分享站 (Firebase版)</p>
                    <button id="helpBtn" class="absolute top-2 right-2 text-4xl hover:scale-110 transition-transform">❓</button>
                </header>
                <div class="bg-red-100 border-4 border-red-500 text-red-700 px-6 py-4 rounded-lg pop-shadow" role="alert">
                    <strong class="font-bold font-anton text-2xl">設定尚未完成！</strong>
                    <p class="block mt-2">您必須先設定自己的 Firebase 後端資料庫才能使用本工具。</p>
                    <p class="mt-2">請依照「❓」圖示中的教學，將您自己的 <code>firebaseConfig</code> 貼到程式碼中，然後重新整理頁面。</p>
                </div>
            `;
            // 讓錯誤訊息中的問號也能打開說明
            document.getElementById('helpBtn').addEventListener('click', () => {
                 helpModal.classList.remove('hidden');
            });
            // 關閉說明
            closeModalBtn.addEventListener('click', () => {
                helpModal.classList.add('hidden');
            });
            
        } else {
            // --- Firebase 初始化 ---
            let app, auth, db;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                alert("Firebase 初始化失敗！請檢查您是否已將正確的 firebaseConfig 貼入程式碼中，並確認網路連線正常。");
            }
            
            // --- 全局變數 ---
            let fileToDelete = null;
            let currentUploadMode = 'file'; // 'file' or 'code'
            let currentUserId = ''; // 這是自訂的使用者ID，例如 'project-A'
            let firebaseUser = null; // 這是 Firebase 的使用者物件
            let unsubscribe = null; // 用來取消 onSnapshot 監聽

            // --- 登入畫面元素 ---
            const loginUserIdInput = document.getElementById('loginUserIdInput');
            const existingUserSelect = document.getElementById('existingUserSelect');
            const loginBtn = document.getElementById('loginBtn');
            const loginStatus = document.getElementById('loginStatus');

            // --- 主應用元素 ---
            const uploadBtn = document.getElementById('uploadBtn');
            const customIdInput = document.getElementById('customId');
            const htmlDescriptionInput = document.getElementById('htmlDescription');
            const statusDiv = document.getElementById('status');
            const cardContainer = document.getElementById('cardContainer');
            
            // --- 使用者ID元素 ---
            const currentUserIdDisplay = document.getElementById('currentUserIdDisplay');
            const switchUserBtn = document.getElementById('switchUserBtn');

            // --- Tab 相關元素 ---
            const tabFileBtn = document.getElementById('tab-file-btn');
            const tabCodeBtn = document.getElementById('tab-code-btn');
            const tabFileContent = document.getElementById('tab-file-content');
            const tabCodeContent = document.getElementById('tab-code-content');
            const htmlFileInput = document.getElementById('htmlFile');
            const htmlCodeInput = document.getElementById('htmlCode');
            const htmlFileNameInput = document.getElementById('htmlFileName');

            // --- 視窗元素 ---
            const helpBtn = document.getElementById('helpBtn');
            const shareModal = document.getElementById('shareModal');
            const closeShareModalBtn = document.getElementById('closeShareModalBtn');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            // --- 分享視窗內部元素 ---
            const shareModalTitle = document.getElementById('shareModalTitle');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const shareUrlInput = document.getElementById('shareUrl');
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            const openLinkBtn = document.getElementById('openLinkBtn');
            const copyStatus = document.getElementById('copyStatus');
            
            // --- 刪除確認視窗內部元素 ---
            const deleteConfirmText = document.getElementById('deleteConfirmText');
            
            // --- 函式定義 ---

            function getKnownUserIds() {
                const ids = localStorage.getItem('popHtmlShare_knownIds_firebase');
                return ids ? JSON.parse(ids) : [];
            }

            function addKnownUserId(id) {
                let ids = getKnownUserIds();
                if (!ids.includes(id)) {
                    ids.push(id);
                    localStorage.setItem('popHtmlShare_knownIds_firebase', JSON.stringify(ids));
                }
            }

            function login(userId) {
                currentUserId = userId;
                localStorage.setItem('popHtmlShare_currentId_firebase', userId);
                addKnownUserId(userId);
                
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                currentUserIdDisplay.textContent = currentUserId;
                loadCards();
            }

            function logout() {
                localStorage.removeItem('popHtmlShare_currentId_firebase');
                location.reload();
            }

            function populateExistingUsers() {
                const ids = getKnownUserIds();
                existingUserSelect.innerHTML = '<option value="">-- 請選擇 --</option>';
                ids.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = id;
                    existingUserSelect.appendChild(option);
                });
            }
            
            async function initializeAppFlow() {
                const urlParams = new URLSearchParams(window.location.search);
                const pageId = urlParams.get('id');

                if (pageId) {
                    loginScreen.classList.add('hidden');
                    loadPageContent(pageId);
                    return;
                }
                
                // 監聽 Firebase 驗證狀態
                onAuthStateChanged(auth, user => {
                    if (user) {
                        firebaseUser = user;
                        console.log("Firebase 已匿名登入，UID:", user.uid);
                        const lastUserId = localStorage.getItem('popHtmlShare_currentId_firebase');
                        if (lastUserId) {
                            login(lastUserId);
                        } else {
                            populateExistingUsers();
                            mainApp.classList.add('hidden');
                            loginScreen.classList.remove('hidden');
                        }
                    } else {
                        // 如果沒有使用者，就進行匿名登入
                        signInAnonymously(auth).catch(error => {
                            console.error("匿名登入失敗:", error);
                            alert("無法連接到後端認證服務，請檢查網路或 Firebase 設定。錯誤：" + error.code);
                        });
                    }
                });
            }
            
            async function loadPageContent(id) {
                document.body.innerHTML = '<div class="font-anton text-2xl text-center p-10">LOADING...</div>';
                try {
                    const docRef = doc(db, "pages", id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const htmlContent = docSnap.data().content;
                        document.open();
                        document.write(htmlContent);
                        document.close();
                    } else {
                        throw new Error("找不到此頁面。");
                    }
                } catch (error) {
                    document.body.innerHTML = `<div class="p-8 bg-red-200 border-4 border-red-800 text-red-900">
                        <h1 class="font-anton text-4xl">載入錯誤</h1>
                        <p class="mt-4">無法載入頁面內容。請檢查您的網址是否正確，或網路連線是否正常。</p>
                        <p class="mt-2">錯誤訊息: ${error.message}</p>
                        <a href="${window.location.pathname}" class="inline-block mt-4 bg-blue-500 text-white p-2 rounded">返回首頁</a>
                    </div>`;
                }
            }
            
            // 使用 onSnapshot 實現即時更新
            function loadCards() {
                 if (!currentUserId || !firebaseUser) {
                    cardContainer.innerHTML = '<p class="text-center col-span-full text-red-600 font-bold">請先設定使用者ID。</p>';
                    return;
                }

                // 如果已經有監聽器，先取消它
                if (unsubscribe) {
                    unsubscribe();
                }
                
                cardContainer.innerHTML = '<p class="text-center col-span-full">讀取中...</p>';
                
                const q = query(collection(db, "pages"), where("customUserId", "==", currentUserId));
                
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    cardContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        cardContainer.innerHTML = '<p class="text-center col-span-full text-gray-500">您尚未建立任何圖卡。</p>';
                    } else {
                        const cardsData = [];
                        querySnapshot.forEach((doc) => {
                           cardsData.push({ id: doc.id, ...doc.data() });
                        });

                        // 在前端排序，確保最新上傳的在最前面
                        cardsData.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                        cardsData.forEach(file => {
                            const card = document.createElement('div');
                            card.className = 'card block bg-white p-6 border-4 border-black rounded-lg pop-shadow cursor-pointer';
                            card.innerHTML = `
                                <button class="delete-btn" title="刪除檔案">&times;</button>
                                <div class="card-content">
                                    <h3 class="font-bold text-lg truncate">${file.filename}</h3>
                                    <p class="text-sm text-gray-700 mt-2 h-10 overflow-hidden">${file.description || '沒有提供說明'}</p>
                                    <p class="text-xs text-gray-500 mt-2 break-all">ID: ${file.id}</p>
                                </div>
                            `;
                            card.querySelector('.card-content').addEventListener('click', () => showShareModal(file.id, file.filename));
                            card.querySelector('.delete-btn').addEventListener('click', () => showDeleteConfirm(file.id, file.filename));
                            cardContainer.appendChild(card);
                        });
                    }
                }, (error) => {
                     cardContainer.innerHTML = `<p class="text-center col-span-full text-red-600 font-bold">
                        無法載入列表。<br>
                        錯誤訊息: ${error.message}<br>
                        請確認您已完成「❓」說明中的所有設定，並將正確的 Firebase 設定碼貼入程式碼中。
                    </p>`;
                    console.error("讀取卡片列表失敗:", error);
                });
            }

            function showShareModal(id, filename) {
                const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
                shareModalTitle.textContent = filename;
                shareUrlInput.value = url;
                openLinkBtn.href = url;
                
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, { text: url, width: 200, height: 200 });

                copyStatus.textContent = '';
                shareModal.classList.remove('hidden');
            }

            function showDeleteConfirm(id, filename) {
                fileToDelete = { id, filename };
                deleteConfirmText.innerHTML = `您確定要刪除檔案 "<strong class="text-red-700">${filename}</strong>" 嗎？此操作無法復原。`;
                deleteConfirmModal.classList.remove('hidden');
            }

            async function handleDelete() {
                if (!fileToDelete || !firebaseUser) return;
                showStatus('刪除中...', 'loading');
                try {
                    await deleteDoc(doc(db, "pages", fileToDelete.id));
                    showStatus(`檔案 "${fileToDelete.filename}" 已刪除。`, 'success');
                    // onSnapshot 會自動更新畫面，所以不需要手動呼叫 loadCards()
                } catch (error) {
                    showStatus(`刪除失敗: ${error.message}`, 'error');
                    console.error("刪除失敗:", error);
                } finally {
                    deleteConfirmModal.classList.add('hidden');
                    fileToDelete = null;
                }
            }
            
            function switchTab(mode) {
                currentUploadMode = mode;
                if (mode === 'file') {
                    tabFileBtn.classList.remove('tab-btn-inactive');
                    tabFileBtn.classList.add('tab-btn-active');
                    tabCodeBtn.classList.remove('tab-btn-active');
                    tabCodeBtn.classList.add('tab-btn-inactive');
                    tabFileContent.classList.remove('hidden');
                    tabCodeContent.classList.add('hidden');
                } else { // code mode
                    tabCodeBtn.classList.remove('tab-btn-inactive');
                    tabCodeBtn.classList.add('tab-btn-active');
                    tabFileBtn.classList.remove('tab-btn-active');
                    tabFileBtn.classList.add('tab-btn-inactive');
                    tabCodeContent.classList.remove('hidden');
                    tabFileContent.classList.add('hidden');
                }
                statusDiv.textContent = '';
            }

            async function handleUpload() {
                const customId = customIdInput.value.trim();
                const description = htmlDescriptionInput.value.trim();

                if (customId && !/^[a-zA-Z0-9-]+$/.test(customId)) {
                    showStatus('自訂ID只能包含英文、數字和連字號 (-)', 'error');
                    return;
                }
                
                if (currentUploadMode === 'file') {
                    const file = htmlFileInput.files[0];
                    if (!file) {
                        showStatus('請先選擇一個 HTML 檔案！', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadContent(e.target.result, file.name, customId, description);
                    };
                    reader.readAsText(file);
                } else {
                    const filename = htmlFileNameInput.value.trim();
                    const content = htmlCodeInput.value.trim();
                    if (!filename || !content) {
                        showStatus('檔案名稱和 HTML 程式碼為必填項目！', 'error');
                        return;
                    }
                    uploadContent(content, filename, customId, description);
                }
            }

            async function uploadContent(content, filename, id, description) {
                 if (!firebaseUser) {
                    showStatus('錯誤：使用者未登入，無法上傳。', 'error');
                    return;
                }
                showStatus('上傳中，請稍候...', 'loading');
                try {
                    const data = {
                        userId: firebaseUser.uid, // Firebase Auth User ID for security rules
                        customUserId: currentUserId, // User-defined ID for grouping
                        filename: filename,
                        content: content,
                        description: description,
                        createdAt: serverTimestamp()
                    };

                    if (id) {
                        // 如果有自訂 ID，先檢查是否存在
                        const existingDoc = await getDoc(doc(db, "pages", id));
                        if (existingDoc.exists()) {
                             throw new Error(`ID "${id}" 已經存在，請換一個。`);
                        }
                        await setDoc(doc(db, "pages", id), data);
                    } else {
                        await addDoc(collection(db, "pages"), data);
                    }

                    showStatus(`檔案 "${filename}" 上傳成功！`, 'success');
                    htmlFileInput.value = '';
                    customIdInput.value = '';
                    htmlDescriptionInput.value = '';
                    htmlCodeInput.value = '';
                    htmlFileNameInput.value = '';
                    // onSnapshot 會自動更新畫面
                } catch (error) {
                    showStatus(`上傳失敗: ${error.message}`, 'error');
                    console.error("上傳失敗:", error);
                }
            }

            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'mt-4 text-center font-bold ';
                if (type === 'success') statusDiv.classList.add('text-green-600');
                else if (type === 'error') statusDiv.classList.add('text-red-600');
                else statusDiv.classList.add('text-blue-600');
            }

            // --- 事件監聽器 ---

            loginBtn.addEventListener('click', () => {
                const userId = loginUserIdInput.value.trim();
                if (userId) {
                    login(userId);
                } else {
                    loginStatus.textContent = "使用者ID不能為空！";
                }
            });

            existingUserSelect.addEventListener('change', (e) => {
                loginUserIdInput.value = e.target.value;
            });

            switchUserBtn.addEventListener('click', logout);
            
            tabFileBtn.addEventListener('click', () => switchTab('file'));
            tabCodeBtn.addEventListener('click', () => switchTab('code'));
            
            uploadBtn.addEventListener('click', handleUpload);

            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            closeShareModalBtn.addEventListener('click', () => shareModal.classList.add('hidden'));
            cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', handleDelete);
            
            copyUrlBtn.addEventListener('click', () => {
                shareUrlInput.select();
                try {
                    navigator.clipboard.writeText(shareUrlInput.value).then(() => {
                        copyStatus.textContent = '已成功複製！';
                        setTimeout(() => copyStatus.textContent = '', 2000);
                    });
                } catch (err) {
                    document.execCommand('copy');
                    copyStatus.textContent = '已成功複製！';
                    setTimeout(() => copyStatus.textContent = '', 2000);
                }
            });

            // 啟動應用程式
            initializeAppFlow();
        }
    </script>

</body>
</html>

